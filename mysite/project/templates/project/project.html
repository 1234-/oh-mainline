{% extends 'base/two_columns.html' %}
{% load profile_extras %}

{% block title %}
Projects - {{ project.name }} 
{% endblock title %}

{% block body_id %}project{% endblock body_id %}

{% block description_for_anonymous_users %}
<strong>Learn below</strong>
about how you can help {{ project.name }}
{% endblock %}

{% block pagetop %}

    <noscript>
        <style type='text/css'>
            li form * { display: inherit ! important; }
            li form strong { display: inline ! important; }
            li form.answer_question { float: left; background-color: #ffc; }
            body#project li form a.collapse_answer_form { display: none ! important; }
        </style>
    </noscript>

    <h3 class='supertitle'><a href='{% url mysite.project.views.projects %}'>Projects</a></h3>
    <a href='{{ project.get_url }}'>
    </a>
    <h1>{{ project.name }}</h1>


{% endblock pagetop %}

{% block left %}
    <div class='module contains_questions'>
        <div class='head'>
            <h3>How can people make {{ project.name }} better?</h3>
        </div>
        <div class='body'>
            <div style="font-size: 1.3em" class="you-are-missing-things">
            {% if cookies_disabled %}
            <div>Please enable cookies in order to post answers.</div>
            {% endif %}
            <noscript><div>Please enable javascript in order to post answers.</div></noscript>
            </div>
            <ul id='paragraph_questions' class='questions'>
                {% for question, answers in question2answer %}
                    <li>
                        <h3><strong>Q:</strong>
                            {% include 'question_text.html' %}
                        </h3>
                        <ul class='answers'>
                            {% for answer in answers %}
                                <li id='answer_whose_pk_is_{{ answer.pk }}'>
                                    {% include 'project/voting_controls.html' %}
                                    {% if not question.is_bug_style %}

                                        {% ifequal the_user answer.author %}
                                            {% with 1 as edit_form %}
                                                {% include 'project/forms/paragraph.html' %}
                                            {% endwith %}
                                        {% endifequal %}

                                        <span class="answer" id="answer_{{answer.pk}}">
                                            {{ answer.text|urlize }}
                                            <br/>
                                            {% include 'project/byline.html' %}
                                        </span>

                                    {% else %}

                                        {% ifequal the_user answer.author %}
                                            {% with 1 as edit_form %}
                                                {% include 'project/forms/bug.html' %}
                                            {% endwith %}
                                        {% endifequal %}

                                        <span class="answer" id="answer_{{answer.pk}}">

                                            <div class="bug_answer_title">
                                                {% ifequal the_user answer.author %}
                                                {% endifequal %}
                                                <strong>{{answer.title}}</strong>
                                            </div>
                                            {{answer.text|urlize|linebreaksbr}}
                                            <br/>
                                            {% include 'project/byline.html' %}
                                        </span>

                                    {% endif %}

                            </span>
                            </li>
                        {% endfor %}

                    {# this li allows you to add an answer #}
                    <li>
                        {% if question.is_bug_style %}
                            {% include 'project/forms/bug.html' %}
                        {% else %}
                            {% include 'project/forms/paragraph.html' %}
                        {% endif %}
                    </li>
                </ul>
            </li>
        {% endfor %}
    </ul>
    <strong id="other-questions">
        <a href="{% url mysite.project.views.suggest_question %}?project__pk={{project.pk}}">
            What else do you want to talk about?
        </a>
    </strong>
    </div>
</div><!-- /.module #requests -->

{% endblock left %}

{% block main %}
    {% if random_pfentry %}
    <div class='module' id='bugs'>
        <div class='head'>
            <h3>About {{ project.name }}</h3>
        </div>
        <div class='body'>
            {% if project.icon_for_profile %}
            <div class='project_icon' 
                    style="float: left; width: 64px; margin-right: 20px; background-image: url('{{ project.icon_for_profile.url }}')"
                    ><span class='alt-text'>
                        (logo)
                    </span></div>
            {% endif %}
            <div style='float: left; width: {% if not project.icon_for_profile %}100%{% else %}70%{% endif %};'>
                    <h2 style='font-size: 1.3em; font-weight: normal;'>
                        {% spaceless %}
                            <span>{{ random_pfentry.project_description|urlize|linebreaksbr}}</span>
                        {% endspaceless %}
                    </h2>
                    <p style='font-size: .9em; margin: 5px 0 0 40px;'>
                    from the profile of
                    <a href='{{ random_pfentry.person.profile_url }}'>
                        {% with random_pfentry.person.user as user %}
                        {% include 'name.html' %}
                        {% endwith %}
                    </a>
                </p>
                </div>
        </div>
    </div>
    {% endif %}

    <div class='module' id='wannahelp'>
        <a href='#' id='wannahelp-button' rel='tipsy' title='Newbies and old-bies are welcome!'>I want to help make {{ project.name }} better</a>
    </div>

    <div class='module' id='bugs'>
        <div class='head'>
            <h3>Relatedly</h3>
        </div>
        <div class='body'>
            {% if project.get_open_bugs %}
                <p>
                    Browse {{ project.get_open_bugs|length }}+
                    <a href='/search/?q={{ project.name_with_quotes_if_necessary|urlencode }}'>
                        volunteer opportunit{{ project.get_open_bugs|pluralize:"y,ies"}}
                        matching
                        <strong>{{ project.name }}</strong>.
                    </a>
            </p>
            {% else %}
                <p>
                No volunteer opportunities in {{project.name}} indexed here yet. 
                <a href='/wiki/Bug_trackers'>
                    To add a bug tracker, 
                    visit our wiki</a>.

            </p>
        {% endif %}
      
      {% with mentors as mentors %}
      {% with project.name as topic %}
      {% with 0 as explain_language %}
      {% include 'project/mentor_summary.html' %}
      {% endwith %}
      {% endwith %}
      {% endwith %}

      {% if project.language %}
      {% with language_mentors as mentors %}
      {% with project.language as topic %}
      {% with 1 as explain_language %}
      {% include 'project/mentor_summary.html' %}
      {% endwith %}
      {% endwith %}
      {% endwith %}
      {% endif %}

    </div>
</div><!-- /.module #bugs -->

<div class='module' id='contributors'>
    <div class='head'>
        <h3>Registered contributors ({% firstof project.cached_contributor_count "none yet" %})</h3>
            <ul>
                <li>
                <a href='{% url mysite.profile.views.people %}?q=project:"{{project.name|urlencode}}"' style='float: right; font-weight: normal;'>See all <strong>&raquo;</strong></a>
                </li>
            </ul>
    </div>
    <div class='body'>
        <ul id='people-list'>
            {% for person in contributors %}
                {% include 'profile/person-summary-li.html' %}
            {% empty %}
                No registered contributors yet.  
            {% endfor %}
        </ul>
        <div style='width: 100%; float: left; text-align: right; margin-top: 20px; font-size: 8pt;'>
        To be listed here,
            <a href='{% url mysite.profile.views.portfolio_editor %}'>
                add {{ project.name }} to your
                profile</a>.
        </div>
    </div>
</div>

{% endblock main %}

{% block js %}
    <script type='text/javascript'>
        $(function() {
            $('.add_an_answer')
                .focus(function() {
                    $form = $(this).parent();
                    $form.addClass('active');
                    $form.find('input:text, textarea').unbind('blur');
                });

            $('input:text, textarea').hint();
            // Bind a function to the 'x' on input forms.  this function collapses the form
            $('.collapse_answer_form').click(function(){
                $form = $(this).parent().parent();
                $form.removeClass('active');
                $form.find('input:text, textarea').hint();
                if($form.hasClass('is_edit_form')){
                    $form.hide();
                    answer_id = $(this).attr('id').split('_')[3];
                    console.debug(answer_id);
                    $answer = $("#answer_" + answer_id);
                    $answer.show();
                    $delete_form = $("#delete_form_" + answer_id);
                    $delete_form.show();
                    $edit_link = $("#edit_link_"  + answer_id);
                    $edit_link.show();
                }
                return false;
            });
            $('.edit_link').click(function(){
                answer_id = this.id.split('_')[2];
                $form = $("#edit_form_"  + answer_id);
                $form.show();
                $form.find('input:text, textarea').unbind('blur');
                $answer = $("#answer_"  + answer_id);
                $answer.hide();
                $delete_form = $("#delete_form_"  + answer_id);
                $delete_form.hide();
                $(this).hide();
                $form.find('input:text, textarea').focus();
                return false;
            });
            $("form.delete input").click(function(){
                return confirm('are you sure?');
            });
            ourJacker = new VoteHijacker();
            ourJacker.initialize();
            
        });


var VoteHijacker = function() {};

VoteHijacker.prototype =
{
    initialize: function()
    {
        this.registerEventHandlers();
    },

    registerEventHandlers: function()
    {
        $('form.answervote').each(function() {
            var form = this;
            var answer__pk = /(\d+)$/.exec(form.id)[1];
            var action = /(up|down|clear)vote/.exec(form.action)[1];
            var prefix = 'answer';
            var options = {
                'dataType': 'json',
                'error': function(){
                    alert("Error voting: " + response.error_message);
                },
                'success': function createCallback(answer__pk, form) {
                    return function callback(response) {
                        if(!response.success){
                            if(response.error_message == "Not authenticated."){
                                alert("Please log in to vote.");
                            }
                            else{
                                alert("Error voting: " + response.error_message);
                            }
                            return;
                        }
                        var action = /(up|down|clear)vote/.exec(form.action)[1];
                        var upArrowType = "grey";
                        var upFormAction = "up";
                        var downArrowType = "grey";
                        var downFormAction = "down";

                        if (action == "up")
                        {
                            var upArrowType = "mod";
                            var upFormAction = "clear";
                        }
                        else if (action == "down")
                        {
                            var downArrowType = "mod";
                            var downFormAction = "clear";
                        }

                        VoteHijacker.updateArrow("up", prefix, answer__pk, upArrowType);
                        VoteHijacker.updateArrow("down", prefix, answer__pk, downArrowType);
                        VoteHijacker.updateFormAction("up", prefix, answer__pk, upFormAction);
                        VoteHijacker.updateFormAction("down", prefix, answer__pk, downFormAction);
                        VoteHijacker.updateScore(prefix, answer__pk, response.score);
                    };
                }(answer__pk, form)
            };
            $(this).ajaxForm(options);
        });
    }
};

VoteHijacker.updateArrow = function(arrowType, prefix, id, state)
{
    var img = $('#' + prefix + arrowType + "arrow" + id).get(0);
    var re = new RegExp(arrowType + "(?:mod|grey)\\.png");
    img.src = img.src.replace(re, arrowType + state + ".png");
};

VoteHijacker.updateFormAction = function(formType, prefix, id, action)
{
    var form = $('#' + prefix + formType + id).get(0);
    form.action = form.action.replace(/(?:up|down|clear)vote/, action + "vote");
};

VoteHijacker.updateScore = function(prefix, id, score)
{
    var scoreElement = $('#' + prefix + "score" + id).get(0);
    scoreElement.innerHTML = score.score;
    scoreElement.title = "after " + score.num_votes + " vote" + VoteHijacker.pluralize(score.num_votes);
};

VoteHijacker.pluralize = function(value)
{
    if (value != 1)
    {
        return "s";
    }
    return "";
};
    </script>

{% endblock js %}

{% comment %}
vim: set ai et ts=4 sw=4 nu:
{% endcomment %}
