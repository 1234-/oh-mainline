{% extends 'profile/people.html' %}

{% block title %}
Map of People
{% endblock title %}

{% block people_main %}
        {% if property and value %}
        where {{ property }} = {{ value }}
        {% endif %}
        {% comment %}
            Google loads a map here -- replacing #map_loading_msg, among other things.
            The background image will hide, as intended, a few seconds after page load.
            However, this doesn't seem to work properly when the image is specified
            via an external stylesheet.
        {% endcomment %}
        <div id="search" style="float: right; width: 65%; margin-right: 10px;">
	  <form action=".">
            <ul>
                <li style="display: inline; float: left; margin-right: 10px;">Center the map at:</li>
                <li style="display: inline; margin-right: 10px;" ><input id="location_for_map_centering" name="center" type="text" value="{{ center_name }}"/></li>
                <li style="display: inline; float: left;"><input id="center_the_map" type="submit" style="float: right; display: inline;" value="Center and zoom!"/></li>
            </ul>
	  </form>
        </div>
        <div id="map_canvas" style='float: right; margin-top: 18px; margin-right: 10px; width:65%; height:450px;'>
            <div id='map_loading_msg'>
                <img src='/static/images/icons/throbber.png' />
                <span>Loading map&hellip;</span>
            </div>
        </div>

        {# JavaScript edits this text. #}
        <p id="people-count">Loading...</p>
        
        <ul id="people-list" class="people-list-map">
            {% for person in people %}
                {% if person.user.username %}
                    {% include 'profile/person-summary-li.html' %}
                {% endif %}
            {% endfor %}
        </ul>
        {% endblock people_main %}

{% block js_before_bundle %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
{% endblock js_before_bundle %}

{% block js %}
{{ block.super }}
<script type="text/javascript">
    {% if center_json %}
    var center = {{ center_json|safe}}; /* This comes from Python geocoding the ?center= . */
    var center_name = {{ center_name_json|safe}}; /* This is the string form of the above. */
    {% else  %}
    var center = {'latitude': 0, 'longitude': 0, 'suggested_zoom_level': 1};
    var center_name = '';
    {% endif %}
    mapController = new PeopleMapController(); 
    $(function () {
        mapController.initialize({
                'person_id2data': {{ person_id2data_as_json|safe}},
                'num_of_persons_with_locations': {{ num_of_persons_with_locations }},
                'center': center
        });
        mapController.bindClickHandlersToPeopleListItems();
        var center_and_zoom_the_map = function () {
            var location = $('#location_for_map_centering').val();
            var callback_to_geocode_then_center_and_zoom = function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    mapController.map.setCenter(results[0].geometry.location);
                    mapController.map.setZoom(5);
                }
            };
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode( {'address': location},
                              callback_to_geocode_then_center_and_zoom);
        }
        $('#center_the_map').click(center_and_zoom_the_map);
    });
</script>
{% endblock js %}

{% block js_tests %}
{% comment %}
    This block only shows up if this page has a query string with ?test=1.
    These are JavaScript unit tests. Unless /static/js/tester.js has changed,
    they will run with FireUnit <http://fireunit.org>, which is an extension for
    Firebug <http://getfirebug.com>.
{% endcomment %}
<script type='text/javascript' src="/static/js/profile/map-tests.js"></script>
{% endblock js_tests %}
