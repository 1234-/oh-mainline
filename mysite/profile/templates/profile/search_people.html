{% extends 'profile/people.html' %}
{% load cache %}

{% block body_id %}people-map{% endblock body_id %}
{% block body_class %}
{{ block.super }}
people-list-page
{% endblock body_class %}

{% block title %}
People
{% endblock title %}

{% block people_main %}
    {% if property and value %}
    where {{ property }} = {{ value }}
    {% endif %}

<form action=".">
    <div id='search'>
        <div class='keyword field'>
            <label for='search_profiles'>Search for</label>
            <input id='search_profiles' type='text' value="{{ raw_query }}" name="q">
        </div>
        <div class='location field'>
          <div class="input-and-labels">
            <label for='search_locations'>Near</label>
            <p class="map-error">We couldn't find that location.</p>
            <input id="location_for_map_centering" name="center"
                   type="text" value="{{ center_name }}"/>
	  </div>
        </div>
        <div class='stubmit field'>
          <div class="input-and-labels">
            <label for='search_locations'>&nbsp;</label>
            <input id="center_the_map" type="submit" value="Search"/>
	  </div>
        </div>
	    
    </div>
</form>
    {% if not q %}
    <ul class='suggestions'>
        {% for suggestion in suggestions %}
            <li>
                <span class='introduce_suggestions'>Popular
                    {{ suggestion.display_name}}:</span>
                <ul>
                    {% for thing in suggestion.values|slice:":3" %}
		    {% include 'profile/suggestion_li.html' %}
                    {% endfor %}
                </ul>
                <ul>
                    {% for thing in suggestion.values|slice:"3:" %}
		    {% include 'profile/suggestion_li.html' %}
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul><!-- /.suggestions -->
    {% endif %}
    {% if q %}
    <div id='refine_search'>
        <h3>Filters and other goodies </h3> <a id="toggle_related_searches" href="#">(show)</a>
        <ul class='filter_conjunction'>
	  {% if mentor_count %}
            <li>
                <span class='term'>Looking for a mentor?</span>
                <ul class='filter_disjunction'>
                    <li><a href='?q=can_mentor:"{{q|urlencode}}"'>Find mentors in {{ q }}</a> ({{ mentor_count }})</li>
                </ul>
            </li>
	    {% endif %}
	    {% if suggestions_for_searches_regarding_people_who_can_pitch_in %}
            <li>
                <span class='term'>Looking for help with your project?</span>
                <ul class='filter_disjunction'>
		  {% for suggestion in suggestions_for_searches_regarding_people_who_can_pitch_in %}
                  <li><a href='?q=seeking:{{suggestion.query|urlencode}}'>Find people who can pitch in with
                      {{ suggestion.query }}</a> ({{suggestion.count}})</li>
		  {% endfor %}
                </ul>
            </li>
	    {% endif %}
	    {% if matching_project_suggestions %}
            <li>
                <span class='term'>Projects matching &lsquo;{{q}}&rsquo;:</span>
                <ul>
		  {% for project in matching_project_suggestions %}
                  <li style="clear: both;"><a href='?q=project:{{project.name_with_quotes_if_necessary}}'>{{project.name}}</a></li>
		  {% endfor %}

                </ul>
            </li>
	    {% endif %}
        </ul>
    </div><!-- /#refine_search -->
    {% endif %}

    <div id='search_summary'>
        People 
        {% if q %}
            {# If there's a query, tell us the people who match it. #}
	{{ this_query_summary }}
            &lsquo;<strong>{{ q }}</strong>&rsquo;:
        {% else %}
            {% comment %}
                If there's *no query*, we list *everybody* in the DB on this page.
            {% endcomment %}
            on OpenHatch: 
        {% endif %}
        <strong id='people-count'>{{ people|length }}</strong>.

        {% comment %}
            Javascript fills these in when the map changes.
        {% endcomment %}
	{% if people %}
        <span class='hide_once_map_loads'>Loading map...</span>
	{% endif %}
        <span class='dont_show_until_map_loads'>
            <span id='how_many_people_are_visible_label'>
                Currently visible on the map:
            </span>
            <strong id='how_many_people_are_visible'></strong>.
            <a href='' {# refresh the page #} id='show_everybody'>(Show everybody.)</a>
        </span>

        {% for project in projects_that_match_q_exactly %}
            <div class='project-yeller'>
                &lsquo;{{ project.name }}&rsquo; also refers to <a href='?q=project:{{project.name_with_quotes_if_necessary|urlencode}}'>a project with {{ project.get_contributors|length}} contributor{{ project.get_contributors|length|pluralize}}.</a>
            </div><!-- /.project-yeller -->
        {% endfor %}
    </div><!-- /#search_summary -->

    {% if people %}

    {% comment %}
        Google loads a map here -- replacing #map_loading_msg, among other things.
        The background image will hide, as intended, a few seconds after page load.
        However, this doesn't seem to work properly when the image is specified
        via an external stylesheet.
    {% endcomment %}

    <div id="map_canvas" style='float: right; margin-right: 10px; width:65%; height:450px;'>
        <div id='map_loading_msg'>
            <img src='/static/images/icons/throbber.png' />
            <span>Loading map&hellip;</span>
        </div>
    </div>

    {# JavaScript edits this text. #}
    
    <ul id="people-list" class="people-list-map">
        {% for person in people %}
            {% if person.user.username %}
                {% include 'profile/person-summary-li.html' %}
            {% endif %}
        {% endfor %}
    </ul>

    {% endif %}

    {% if center_json and not geocode_failed %}
    <style type='text/css'>
    #people-list li { display: none; }
    </style>
    {% endif %}

{% endblock people_main %}

{% block js_before_bundle %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
{% endblock js_before_bundle %}

{% block js %}
{{ block.super }}
{% if people %}
<script type="text/javascript">
    {% if center_json and not geocode_failed %}
        var center = {{ center_json|safe}}; /* This comes from Python geocoding the ?center= . */
        var center_name = {{ center_name_json|safe}}; /* This is the string form of the above. */
    {% else %}
        var center = {'latitude': 0, 'longitude': 0, 'suggested_zoom_level': 1};
        var center_name = '';
    {% endif %}

    {% if geocode_failed %}
        $('.map-error').show();
    {% endif %}

    mapController = new PeopleMapController(); 
    $(function () {
        mapController.initialize({
                'person_id2data': {{ person_id2data_as_json|safe}},
                'num_of_persons_with_locations': {{ num_of_persons_with_locations }},
                'center': center

        });
        mapController.bindClickHandlersToPeopleListItems();
    });

var related_searches_toggler = function () {
    var thing_to_show_or_hide = $('.filter_conjunction');
    if (thing_to_show_or_hide.is(":visible")) {
	thing_to_show_or_hide.hide();
    } else { 
	thing_to_show_or_hide.show();
    }
    return false;
};

$(function() {
	$('#toggle_related_searches').click(related_searches_toggler); });
    
</script>
{% endif %}
{% endblock js %}

{% block js_tests %}
{% comment %}
    This block only shows up if this page has a query string with ?test=1.
    These are JavaScript unit tests. Unless /static/js/tester.js has changed,
    they will run with FireUnit <http://fireunit.org>, which is an extension for
    Firebug <http://getfirebug.com>.
{% endcomment %}
<script type='text/javascript' src="/static/js/profile/map-tests.js"></script>
{% endblock js_tests %}
