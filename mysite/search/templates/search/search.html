{% extends 'search/base.html' %}

{% block title %}
Search bugs 
{{ block.super }}
{% endblock title %}

{% block sidebar %}
<div id='suggested-searches' class='box module'>
    <h3 style='margin-bottom: 10px;'>Suggested searches:</h3>
    <a id='toggle-more-suggestions' href='#'>
        Show <span>more</span> suggestions
    </a>
    <form name='suggested_searches'
        method='GET' action=''>
        <ul>
            {% for index, show_me, term, czeched in suggestions %}
            <li{% if not show_me %} class='hidden'{% endif %}>
            <input id='term_{{ index }}' name='term_{{ index }}' type='checkbox'
            {% if czeched %}checked='on'{% endif %} %} />
            <label for='term_{{ index }}'>{{ term }}</label>
            </li>
            {% endfor %}
        </ul>
        <input type='submit' value='Find bugs'/>
    </form>
</div>
{% endblock sidebar %}

{% block main %}
    <div id='results' class='gewgaws module box results'>
    <div id='opps'>
        <form name='search_opps' method='get'> 
            <h3><label for='language'>Find some bugs!</label></h3>
            <input type='text' name='language' id='language'
            value='{{ language }}' />
            <input type='submit' id='button' value='Go' />
        </form>

        <div id='results-widget'>
            <span id='results-summary'>
                <span id='results-summary-language'>{{ language }}</span>

                {% if bunch_of_bugs %}
                Showing results 
                <span id='results-summary-start'>{{ start }}</span>
                to
                <span id='results-summary-end'>{{ end }}</span>.
                {% endif %}
            </span>

            <span class='separator'>&nbsp;</span>

            <span id='navigation'>
                <a href='{{ prev_page_url }}' id='prev-page'>&laquo; Prev</a>
                <span class='separator'>&nbsp;</span>
                <a href='{{ next_page_url }}' id='next-page'>Next page &raquo;</a>
                <span class='separator'>&nbsp;</span>
                <a href='EXPAND_ALL_URL' id='expand-all-link'>Expand all</a>
                <a href='COLLAPSE_ALL_URL' id='collapse-all-link'>Collapse all</a>
            </span>

        </div><!-- /#results-widget -->

        {% if bunch_of_bugs %}
        <ul>
            {# Search results {{{ #}
            {% for bug in bunch_of_bugs %}
            <li class='bug {% cycle "even" "odd"%}'>
            <!--div class='project-info'>
            <img class='logo' src='{{ bug.project.icon_url }}' />
            </div-->
            <div class='first-line'>
                <a class='title' href='{{ bug.canonical_bug_link }}'
                    >+
                    <span>{{ bug.project.name }} - {{ bug.title }}</span>
                </a>
                <!--div class='age'>3 days old</div-->
            </div>
            <div class='second-line'>
                <span class='description'>
                    {% if bug.good_for_newcomers %}
                    <span class='good-for-beginners' style='width: 300px; '>
                        Good for newcomers &bull;
                    </span>
                    {% endif %}
                    {{ bug.description }}
                </span>
            </div>
            {% comment %} Details {{{ {% endcomment %}
            <div class='details'>
                <div class='fields'>
                    <span class='field importance'>
                        <label>People involved: </label>
                        <span class='value'>
                            <a href=''>13</a>
                        </span>
                    </span>
                    <span class='field status'>
                        <label>Status: </label>
                        <span class='value'>triaged</span>
                    </span>
                    <span class='field last-polled'>
                        <label>Last touched: </label>
                        <span class='value'>2 weeks ago</span>
                    </span>
                    <span class='field origin'>
                        <label>Link: </label>
                        <span class='value'>
                            <a href='{{ bug.canonical_bug_link }}'>Upstream issue</a>
                        </span>
                    </span>
                    <span class='field importance'>
                        <label>Importance: </label>
                        <span class='value'>wishlist</span>
                    </span>
                    <span class='field last-polled'>
                        <label>Last polled: </label>
                        <span class='value'>3 days ago</span>
                        <!--a href=''>poll now</a-->
                    </span>
                </div>
            </div>
            {% comment %} }}} {% endcomment %}
            </li>
            {% endfor %}
            {# }}} #}
        </ul>
        {% else %}
        <p class='no-opps'>
        No opportunities found matching your query: {{ language }}.
        </p>
    {% endif %}

    </div> <!-- /#results -->
    </div> <!-- /#opps -->
{% endblock main %}
{% block js %}
{{ block.super }}
<script>
Suggns = {
    '$list': null,
    '$toggleLink': null,
    '$submitButton': null,
    '$hiddenItems': null,
    '$terms': null,
    '$queryField': null,
    'init': function() {

        // Initialize variables that store jQuery objects.
        Suggns.$list = $('#suggested-searches ul');
        Suggns.$toggleLink = $('#toggle-more-suggestions');
        Suggns.$submitButton = $('#suggested-searches input[type="submit"]');
        Suggns.$hiddenItems = $('#suggested-searches li.hidden');
        Suggns.$terms = $('#suggested-searches li');
        Suggns.$queryField = $('#language');

        // Bind event handlers.
        Suggns.bindToggler();
        Suggns.bindQueryManipulators();
        Suggns.bindCheckboxUpdater();

        // 
        Suggns.$submitButton.hide();
    },
    'bindToggler': function() {
        Suggns.$toggleLink.click(Suggns.toggler);
    },
    'toggler': function() {
        var isHidden = Suggns.$hiddenItems.eq(0).is(':hidden');
        var verb = isHidden ? 'show' : 'hide';
        var determiner = isHidden ? 'fewer' : 'more';
        Suggns.$hiddenItems[verb]();
        Suggns.$toggleLink.find('span').text(determiner);
        return false;
    },
    'bindQueryManipulators': function() {
        Suggns.$terms.find('input[type="checkbox"]').change(Suggns.queryManipulator);
    },
    'queryManipulator': function() {
        var q = Suggns.$queryField;
        var term = $.trim($(this).parent().find('label').text());

        /* Add quotes to terms with whitespace.*/
        if (term.match(/\s/) !== null) {
            term = "\"" + term + "\"";
        }
        if ($(this).is(":checked")) {
            var separator = (q.val().replace(/\s/g, "") == "") ? "" : " ";
            q.val(q.val() + separator + term);
        }
        else {
            var termRegExp = new RegExp("\\s" + RegExp.escape(term) + "\\s", "i");
            q.val((" "+q.val()+" ").replace(termRegExp, ""));
        }
        q.val($.trim(q.val().replace(/\s+/g, " ")));
    },
    'checkboxUpdater': function() {
        var query = Suggns.$queryField.val();
        var termDelimiter = RegExp(/\s/);
        var terms = query.toLowerCase().split(termDelimiter);
        Suggns.$terms.each(function() {
            var value = "";
            if (terms.contains($(this).find('label').text().toLowerCase())) {
                value = "checked";
            }
            $(this).find('input:checkbox').attr('checked', value);
        });
    },
    'bindCheckboxUpdater': function() {
        Suggns.$queryField.keyup(Suggns.checkboxUpdater);
    },
    'getCheckboxByTerm': function(term) {
    }
};
$(Suggns.init);
</script>
{% endblock js %}
