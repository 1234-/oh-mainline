{% extends 'search/base.html' %}

{% block title %}
Search bugs 
{{ block.super }}
{% endblock title %}

{% block sidebar %}
<div id='suggested-searches' class='box module'>
    <h3 style='margin-bottom: 10px;'>Suggested searches:</h3>
    <form name='suggested_searches'
        method='GET' action=''>
        <ul>
            {% for index, show_me, term, czeched in suggestions %}
            <li{% if not show_me %} class='hidden'{% endif %}>
            <input id='term_{{ index }}' name='term_{{ index }}' type='checkbox'
            {% if czeched %}checked='on'{% endif %} %} />
            <label for='term_{{ index }}'>{{ term }}</label>
            </li>
            {% endfor %}
        </ul>
        <a id='toggle-more-suggestions' href='#'>
            Show <span>more</span> suggestions
        </a>
        <input type='submit' value='Find bugs'/>
    </form>
</div>
{% endblock sidebar %}

{% block main %}
    <div id='results' class='gewgaws module box results'>
    <div id='opps'>
        <form name='search_opps' method='get'> 
            <h3><label for='language'>Find some bugs!</label></h3>
            <input type='text' name='language' id='language'
            value='{{ language }}' />
            <input type='submit' id='button' value='Go' />
        </form>

        <div id='results-widget'>
            <span id='results-summary'>
                <span id='results-summary-language'>{{ language }}</span>

                {% if bunch_of_bugs %}
                Showing results 
                <span id='results-summary-start'>{{ start }}</span>
                to
                <span id='results-summary-end'>{{ end }}</span>.
                {% endif %}
            </span>

            <span class='separator'>&nbsp;</span>

            <span id='navigation'>
                <a href='{{ prev_page_url }}' id='prev-page'>&laquo; Prev</a>
                <span class='separator'>&nbsp;</span>
                <a href='{{ next_page_url }}' id='next-page'>Next page &raquo;</a>
                <span class='separator'>&nbsp;</span>
                <a href='EXPAND_ALL_URL' id='expand-all-link'>Expand all</a>
                <a href='COLLAPSE_ALL_URL' id='collapse-all-link'>Collapse all</a>
            </span>

        </div><!-- /#results-widget -->

        {% if bunch_of_bugs %}
        <ul>
            {# Search results {{{ #}
            {% for bug in bunch_of_bugs %}
            <li class='bug {% cycle "even" "odd"%}'>
            <!--div class='project-info'>
            <img class='logo' src='{{ bug.project.icon_url }}' />
            </div-->
            <div class='first-line'>
                <a class='title' href='{{ bug.canonical_bug_link }}'
                    >+
                    <span>{{ bug.project.name }} - {{ bug.title }}</span>
                </a>
                <!--div class='age'>3 days old</div-->
            </div>
            <div class='second-line'>
                <span class='description'>
                    {% if bug.good_for_newcomers %}
                    <span class='good-for-beginners' style='width: 300px; '>
                        Good for newcomers &bull;
                    </span>
                    {% endif %}
                    {{ bug.description }}
                </span>
            </div>
            {% comment %} Details {{{ {% endcomment %}
            <div class='details'>
                <div class='fields'>
                    <span class='field importance'>
                        <label>People involved: </label>
                        <span class='value'>
                            <a href=''>13</a>
                        </span>
                    </span>
                    <span class='field status'>
                        <label>Status: </label>
                        <span class='value'>triaged</span>
                    </span>
                    <span class='field last-polled'>
                        <label>Last touched: </label>
                        <span class='value'>2 weeks ago</span>
                    </span>
                    <span class='field origin'>
                        <label>Link: </label>
                        <span class='value'>
                            <a href='{{ bug.canonical_bug_link }}'>Upstream issue</a>
                        </span>
                    </span>
                    <span class='field importance'>
                        <label>Importance: </label>
                        <span class='value'>wishlist</span>
                    </span>
                    <span class='field last-polled'>
                        <label>Last polled: </label>
                        <span class='value'>3 days ago</span>
                        <!--a href=''>poll now</a-->
                    </span>
                </div>
            </div>
            {% comment %} }}} {% endcomment %}
            </li>
            {% endfor %}
            {# }}} #}
        </ul>
        {% else %}
        <p class='no-opps'>
        No opportunities found matching your query: {{ language }}.
        </p>
    {% endif %}

    </div> <!-- /#results -->
    </div> <!-- /#opps -->
{% endblock main %}
{% block js %}
{{ block.super }}
<script>
Suggestions = {
    '$list': null,
    '$toggleLink': null,
    '$submitButton': null,
    '$hiddenItems': null,
    '$terms': null,
    '$queryField': null,
    'init': function() {
        Suggestions.$list = $('#suggested-searches ul');
        Suggestions.$toggleLink = $('#toggle-more-suggestions');
        Suggestions.$submitButton = $('#suggested-searches input[type="submit"]');
        Suggestions.$hiddenItems = $('#suggested-searches li.hidden');
        Suggestions.$terms = $('#suggested-searches li');
        Suggestions.$queryField = $('#language');
        Suggestions.bindToggler();
        Suggestions.bindQueryManipulators();
        Suggestions.$submitButton.hide();
    },
    'bindToggler': function() {
        Suggestions.$toggleLink.click(Suggestions.toggler);
    },
    'toggler': function() {
        var hidden = Suggestions.$hiddenItems.eq(0).is(':hidden');
        var action = hidden ? 'show' : 'hide';
        var adjective = hidden ? 'fewer' : 'more';
        Suggestions.$hiddenItems[action]();
        Suggestions.$toggleLink.find('span').text(adjective);
        return false;
    },
    'bindQueryManipulators': function() {
        Suggestions.$terms.find('input[type="checkbox"]').change(Suggestions.queryManipulator);
    },
    'queryManipulator': function() {
        var q = Suggestions.$queryField;
        var term = $(this).parent().find('label').text();
        if ($(this).is(":checked")) {
            var separator = (q.val().replace(/\s/g, "") == "") ? "" : " ";
            q.val(q.val() + separator + term);
        }
        else {
            // FIXME: Escape term.
            var termRegExp = new RegExp("\\s" + term + "\\s", "i");
            q.val((" "+q.val()+" ").replace(termRegExp, ""));
        }
        q.val($.trim(q.val().replace(/\s+/g, " ")));
    }
};
$(Suggestions.init);
</script>
{% endblock js %}
